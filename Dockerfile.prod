### üèó √âtape 1 : Construction de l‚Äôapplication
FROM node:22-alpine AS build

# Installer les d√©pendances n√©cessaires √† la compilation (sharp, esbuild, etc.)
RUN apk update && apk add --no-cache \
  build-base \
  python3 \
  bash \
  vips-dev \
  git \
  autoconf \
  automake \
  libpng-dev \
  zlib-dev \
  nasm \
  libtool \
  make \
  g++

WORKDIR /opt/app

# Copier les fichiers de d√©pendances
COPY package*.json ./

# Installer les d√©pendances de production
RUN npm install --production

# Copier tout le reste
COPY . .

# Supprimer les binaires esbuild et compiler l'application
RUN rm -rf node_modules/esbuild/bin/* && npm run build

# üßπ Nettoyage : optionnel mais recommand√© (√ßa r√©duit un peu l'image)
#RUN npm prune --production

### üèÅ √âtape 2 : Image finale plus l√©g√®re
FROM node:22-alpine

# Installer uniquement les libs n√©cessaires √† Strapi en runtime
RUN apk add --no-cache vips-dev

WORKDIR /opt/app

# Copier le build et les d√©pendances depuis l‚Äôimage de build
COPY --from=build /opt/app ./

# Donner les permissions √† l‚Äôutilisateur "node"
RUN chown -R node:node /opt/app
USER node

EXPOSE 1337

CMD ["npm", "run", "start"]
